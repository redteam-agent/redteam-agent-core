"""Result models for chain execution"""

from enum import Enum

from pydantic import BaseModel


class ChainType(str, Enum):
    """Type of chain being executed."""

    EXPLOIT = "exploit"
    REMEDIATION = "remediation"


class StepStatus(str, Enum):
    """Status of a chain step."""

    PENDING = "pending"
    RUNNING = "running"
    SUCCESS = "success"
    FAILED = "failed"
    SKIPPED = "skipped"


class ChainStep(BaseModel):
    """
    A single step in an exploit or remediation chain.

    The LLM generates these steps, and the executor service runs them.
    """

    step_number: int
    chain_type: ChainType
    reasoning: str  # Extracted from LLM <think> tags
    command: str  # The command to execute
    expected_outcome: str  # What we expect to see if successful
    success_criteria: str  # How to determine success
    fallback_strategy: str | None = None  # What to try if this fails
    status: StepStatus = StepStatus.PENDING
    output: str | None = None
    exit_code: int | None = None
    duration_ms: int | None = None


class ExploitResult(BaseModel):
    """
    Result of an exploit chain execution.

    Contains all information about the exploit attempt, including
    the steps executed and evidence of successful exploitation.
    """

    success: bool
    vulnerability_id: str
    vulnerability_type: str
    severity: str
    steps_executed: list[ChainStep]
    total_steps: int
    evidence: str | None = None  # Proof of exploitation
    impact: str | None = None  # What was accessed/achieved
    summary: str  # Human-readable summary


class CodeFix(BaseModel):
    """
    A code fix generated by the remediation chain.

    Contains the original and fixed code, along with a diff and explanation.
    """

    file_path: str
    original_code: str
    fixed_code: str
    diff: str  # Unified diff format
    explanation: str  # Why this fix works
    line_start: int
    line_end: int


class RemediationResult(BaseModel):
    """
    Result of a remediation chain execution.

    Contains information about the fixes applied and verification status.
    """

    success: bool
    exploit_result: ExploitResult  # The exploit we're fixing
    code_fixes: list[CodeFix]
    verification_passed: bool  # Did re-running the exploit fail?
    attempts: int  # How many fix attempts were made
    final_error: str | None = None  # Error message if failed
