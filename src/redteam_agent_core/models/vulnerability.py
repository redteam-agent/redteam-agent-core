"""Vulnerability-related models"""

from enum import Enum

from pydantic import BaseModel


class Severity(str, Enum):
    """Vulnerability severity levels."""

    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"


class SecurityIssue(BaseModel):
    """
    A security issue found by the security-use scanner.

    This is the primary input to the exploit chain.
    """

    id: str  # Unique identifier
    severity: Severity
    category: str  # SQL_INJECTION, XSS, SSRF, IDOR, etc.
    title: str
    description: str
    file_path: str | None = None  # Source file if applicable
    line_number: int | None = None
    code_snippet: str | None = None
    cwe_id: str | None = None  # CWE-89, CWE-79, etc.
    cvss_score: float | None = None
    remediation_hint: str  # Initial guidance from scanner
    confidence: float = 1.0  # Scanner's confidence (0-1)


class VulnerabilityInfo(BaseModel):
    """
    Vulnerability information from the knowledge base (crawled via Firecrawl).

    This is used to provide context to the LLM for exploit generation.
    """

    cve_id: str | None = None
    cwe_id: str | None = None
    title: str
    description: str
    severity: Severity
    affected_technologies: list[str] = []  # ["python", "django", "postgresql"]
    exploitation_techniques: list[str] = []  # Step-by-step techniques
    proof_of_concepts: list[str] = []  # Example exploit code/commands
    remediation: str
    references: list[str] = []  # URLs to more info
    source: str  # "nvd", "exploit-db", "owasp"


class VulnerabilityKnowledgeBase(BaseModel):
    """
    Aggregated vulnerability knowledge base.

    Built by crawling NVD, Exploit-DB, and OWASP using Firecrawl.
    """

    vulnerabilities: list[VulnerabilityInfo]
    crawled_at: str  # ISO timestamp
    sources: list[str]  # ["nvd", "exploit-db", "owasp"]

    def search_by_cwe(self, cwe_id: str) -> list[VulnerabilityInfo]:
        """Find vulnerabilities matching a CWE ID."""
        return [v for v in self.vulnerabilities if v.cwe_id == cwe_id]

    def search_by_technology(self, tech: str) -> list[VulnerabilityInfo]:
        """Find vulnerabilities affecting a technology."""
        tech_lower = tech.lower()
        return [
            v for v in self.vulnerabilities
            if any(tech_lower in t.lower() for t in v.affected_technologies)
        ]

    def search_by_category(self, category: str) -> list[VulnerabilityInfo]:
        """Find vulnerabilities by category (sql_injection, xss, etc)."""
        category_lower = category.lower()
        return [
            v for v in self.vulnerabilities
            if category_lower in v.title.lower() or category_lower in v.description.lower()
        ]
